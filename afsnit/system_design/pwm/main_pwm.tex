\documentclass[../../../Main]{subfiles}
\begin{document}

\subsection{PWM}
In this section the implementation and calculations of PWM\footnote{Pulse Width Modulation} generation is described. PWM is a way of controlling the speed of DC-motors. It work by varying the time a given voltage is applied to the motor, relative to the time it is not. This relationship is called the duty cycle of the PWM signal. The duty cycle is depicted in figure \ref{fig:pwm}.

\begin{figure}[h]
  \includesvg[\main/afsnit/system_design/pwm/img/]{drawing}
  \caption{Illustration of PWM signal. $P_{pwm}$ is the period of PWM signal.}
  \label{fig:pwm}
\end{figure}

The duty cycle can be varied from $0 - 100\%$. Translating to a DC-motor torque of $0 - max$.
The PWM signal is generated using the FPGA, which is a hard requirement from the project  specification. To generate a PWM signal as in figure \ref{fig:pwm} a counter on the FPGA  is used.
The output signal is set high, as soon as the counter starts counting. When the counter reaches the calcutaled value for a given dutycycle, the output signal is set LOW. When the counter then reaches its precalculated maximum value, the process starts over. Thus generating a PWM output. The maximum counter value is calculated based on the wanted frequency of the PWM signal. The frequency of the signal is important for a correct operation of the DC-motor, and depends on specific parameters of the motor. The optimal frequency of the motors in this project is calculated in the following section.
\newpage
\subsubsection{Determining the PWM frequency}

A DC-motor can be modeled by the equivalent circuit depicted in figure \ref{fig:electrical_equ}.

\begin{figure}[ht]
	\center
	\includesvg[\main/afsnit/system_design/pwm/img/]{electrical_motor_equ}
	\caption{Electrically equivalent DC-motor circuit.}
  \label{fig:electrical_equ}
\end{figure}
The circuit in figure \ref{fig:electrical_equ} can be described with equation \ref{equ:equ_circuit_full}. With the parameters $R$ resistance in Ohms, $L$ inductance in Henry and $V_b$ the back EMF generated by the motor when it is at speed.
\begin{align}
	V(t) &= V_R(t) + V_L(t) + b\dot{\theta}\\
 \label{equ:equ_circuit_full}
	V(t) &= V_R(t) + V_L(t) + V_b\\
	\Rightarrow V_b &= b\dot{\theta}
\end{align}

To find the maximum PWM frequency though, it is not necessary to take into account the back emf. This is because the highest PWM frequency possible, is at the exact moment, when the motor starts to move. Therefore a simplified circuit will be used, depicted in figure \ref{fig:electrical} 

\begin{figure}[H]
	\center
	\includesvg[\main/afsnit/system_design/pwm/img/]{electrical_motor}
	\caption{Simplified electrically circuit of DC-motor}
  \label{fig:electrical}
\end{figure}


In a DC-motor the torque of the motor is proportional to the current in the winding's of the motor. The motor winding's have an inductance $L$.
If the motor is supplied by a constant source, the current through the resistance $R$ and the winding's with inductance $L$ is constant, and therefore the torque is constant. This is because a constant voltage over an inductor is equal to a short circuit over the inductor. 
In a system with a PWM source though, the voltage is not constant, and therefore the current through the inductor is not constant.

When choosing a PWM frequency it is therefore necessary to take the changing current in the inductor into account. 

The voltage over the motor in figure \ref{fig:electrical} can be summed using Kirchoffs Voltage Law. 
\begin{align}
	V(t) &= V_R(t) + V_L(t)\\
	V(t) &= R \cdot i + L \cdot \frac{di}{dt}
	\label{equ:diff_equ}
\end{align}
The current $i(t)$ can be found by solving differential equation(\ref{equ:diff_equ}).   
\begin{align}
	i(t) &=\frac{V}{R} \cdot (1-e^{\frac{R}{L} \cdot t})
	\label{equ:isol}
\end{align}

The time constant of equation \ref{equ:isol} is $\tau = \frac{L}{R}$.
As the current flows, the voltage over $L$ becomes smaller, and the voltage over $R$ becomes larger.Only when the voltage $V_L = 0$ the motor draws all of the available current. This implies that at least $5\tau$ must have passed before the output of the PWM signal switches low, otherwise the motor will never draw full current, and thereby it will loose available  torque. This can be seen in figure \ref{fig:currentplot}

\begin{figure}[H]
\centering
\def\svgwidth{\textwidth}
\import{\main/afsnit/system_design/pwm/img/}{current.pdf_tex}
\caption{Plotting the current over time when voltage is supplied to the DC-motor.}
\label{fig:currentplot}
\end{figure}

This implies that the minimum on-pulse of the PWM signal must be at least $5\tau = 5 \cdot \frac{L}{R} = 4.9707 \cdot 10^{-4}s \approx 497\mu s$

The system has a large amount of friction in the motors and gears. This means that the system will not move with a duty cycle below $50\%$. The minimum PWM period is therefore $497\mu s \cdot 2 = 994\mu s$. The maximum frequency is $1/997\mu s = 1003 Hz$.
In figure \ref{fig:currentplot_pwm} the outcome of a PWM frequency of $1003Hz$ can be seen.
In the figure, the voltage is not as in the real system, which is $12V$ here it is the same as the peak current, to gave at better picture. The main point is that the current reaches peak value, before the voltage drops. 

\begin{figure}[H]
\centering
\def\svgwidth{\textwidth}
\import{\main/afsnit/system_design/pwm/img/}{curpwm.pdf_tex}
\caption{Plotting the current through the motor, when voltage is applied.}
\label{fig:currentplot_pwm}
\end{figure}










\end{document}
