\documentclass[../../../main]{subfiles}
\begin{document}
The SPI protocol is a shift register protocol with a possible register size of range from 8 bits to 16 bits\todo{mangler en ref hvis det er rigtigt}.
The communication protocol is designed to keep the size of the data gram less or equal to the register size. This is to ensure a simple protocol between the Tiva and FPGA which is still able to utilize the full duplex capabilities of a SPI protocol. \\
The communication protocol uses the master-slave principle with the Tiva as the master and the FPGA as the slave.\\
When the Tiva Initializes communication "Slave Enable" is driven low and 1 SPI clock cycle later
data will be read on rising edge from the SPI clock, as seen in figure \ref{fig:spi_timing_diagram}.\todo{Syntes ikke figur viser det det skal}
\\
Each datagram is 16 bits in size and the datagram format sent by the Tiva
can be observed in table \ref{tab:package_format_tiva} and the package format send by the FPGA
can be observed in table \ref{tab:package_format_fpga}.
In the package format the bit number indicates the order of transmission starting with 0.

\begin{table}[h]
	\centering
	\begin{tabular}{ll}
		\textbf{Data}& \textbf{Data type}  \\
		\hline
		PWM& 9 bit signed \\
		Position& 12 bit signed \\
		Velocity& 12 bit signed \\
		Amps& 12 bit unsigned \\
		Home Index& 1 bit
	\end{tabular}
	\caption{Data types}
	\label{tab:spi_datatypes}
\end{table}
\todo{fix the taables. is√¶r table 2}
\begin{table}[h]
	\centering
	\begin{tabular}{|*{16}{p{.3cm}|}}
		\hline
		0&1&2&3&4&5&6&7&8&9&10&11&12&13&14&15\\
		\hline
		\multicolumn{9}{|c|}{PWM  - 9bits} & M S&
		\multicolumn{2}{p{.6cm}|}{Resp. select}& R S&
		\multicolumn{3}{c|}{Reserved}
		\\
		\hline
	\end{tabular}
	\caption{Package format - Tiva}
	\label{tab:package_format_tiva}
\end{table}
\begin{table}[H]
	\centering
	\begin{tabular}{ll}
		MS & Motor Select\\
		\hline
		Response select &\\ &
		\begin{tabular}{ll}
			Position & 00\\
			Velocity & 01\\
			Acceleration & 10\\
			Amps & 11
		\end{tabular}
		\\\hline
		RS & Reset Position
		\\\hline
	\end{tabular}
	\caption{Package format extended}
	\label{tab:shorthand}
\end{table}

\begin{table}[H]
	\centering
	\caption{Package format - FPGA}
	\label{tab:package_format_fpga}
	\begin{tabular}{|*{16}{p{.3cm}|}}
		\hline
	 	0& 1& 2& 3& 4& 5& 6& 7& 8& 9& 10& 11& 12& 13& 14& 15\\
		\hline
		\multicolumn{2}{|p{.6cm}|}{Res} & H S 1 & H S 0 &
		\multicolumn{12}{c|}{Requested Data}\\
		\hline
	\end{tabular}
\end{table}


\begin{figure}[h]
	\center
\begin{tikztimingtable}[timing/font=\normalfont]
	{2 MHz Clock}&2L32{t}1L\\
	{Slave Enable}&1H17L1H\\
	{MOSI}&1L17D{MSG \#N}1L\\
	{MISO}&1U17D{Response \#N-1}1U\\
\end{tikztimingtable}
\caption{SPI timing diagram}
\label{fig:spi_timing_diagram}
\end{figure}

\end{document}
